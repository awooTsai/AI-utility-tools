<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>awoo AI 程式碼分析與優化工具</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap"
        rel="stylesheet"
    />
    <style>
        /* 省略原有 CSS */
    </style>
</head>
<body class="bg-[#1a202c] text-slate-200 antialiased">
    <div class="container mx-auto p-4 md:p-6">
        <!-- 省略您原本 HTML 內容 -->
        <button
            id="analyze-btn"
            class="bg-[#c83c32] hover:bg-opacity-90 text-white font-bold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105 shadow-lg shadow-red-500/30 flex items-center justify-center"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 mr-2"
                viewBox="0 0 20 20"
                fill="currentColor"
            >
                <path
                    d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
                />
            </svg>
            <span>✨ AI 分析與優化</span>
        </button>
        <!-- ... 省略其他頁面元素 ... -->
    </div>

    <script>
        /* 省略部分 DOM 取得 */

        // ★ 直接在這裡植入您的 OpenAI API Key（測試專用，勿公開）
        const OPENAI_API_KEY = "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";

        async function callGemini(prompt) {
            if (!OPENAI_API_KEY) {
                throw new Error("API Key 未設定，請先在程式碼中加入您的密鑰");
            }

            const response = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: "Bearer " + OPENAI_API_KEY,
                },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: [{ role: "user", content: prompt }],
                    max_tokens: 2000,
                    temperature: 0.7,
                }),
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || "API 請求失敗，狀態碼：" + response.status);
            }

            const data = await response.json();
            return {
                analysis: data.choices[0].message.content,
                optimizedCode: "// 優化程式碼可在此擴充",
            };
        }

        // 重新定義 performAnalysis，改用 callGemini 呼叫
        async function performAnalysis(analysisType) {
            const userCode = codeInput.value;
            if (!userCode.trim()) {
                resultSection.classList.remove("hidden");
                analysisOutput.innerHTML = '<p class="text-yellow-400">請先在左側輸入框貼上您的程式碼。</p>';
                return;
            }
            setLoading(true);
            resultSection.classList.remove("hidden");
            analysisOutput.innerHTML = "";
            optimizedCodeOutput.value = "";
            try {
                const isCmsContext = cmsContextCheckbox.checked;
                let prompt = "";
                if (analysisType === "optimize") {
                    prompt = getOptimizePrompt(userCode, isCmsContext);
                } else if (analysisType === "accessibility") {
                    prompt = getAccessibilityPrompt(userCode, isCmsContext);
                }
                const result = await callGemini(prompt);
                analysisOutput.innerHTML = marked.parse(result.analysis);
                optimizedCodeOutput.value = result.optimizedCode;
                tabAnalysis.click();
            } catch (error) {
                console.error("Error during AI analysis:", error);
                let errorMessage = '<p class="text-red-400 font-semibold">分析時發生錯誤</p>';
                if (error.status === 401) {
                    errorMessage += `<p class="text-yellow-300 mt-2">驗證錯誤 (401 Unauthorized)。API Key 可能無效或過期。</p>`;
                } else if (error.message.includes("Failed to fetch")) {
                    errorMessage += `<p class="text-yellow-300 mt-2">網路連線錯誤，無法連接到 AI 服務。</p>`;
                } else {
                    errorMessage += `<p class="text-slate-400 mt-2">錯誤細節: ${error.message}</p>`;
                }
                analysisOutput.innerHTML = errorMessage;
            } finally {
                setLoading(false);
            }
        }

        // 保持原本事件綁定
        analyzeBtn.addEventListener("click", () => performAnalysis("optimize"));
        accessibilityBtn.addEventListener("click", () => performAnalysis("accessibility"));

        /* 其餘原本的程式碼不動 */
    </script>
</body>
</html>
